---
# docker image
dapp_mirrordeb_docker_image: "localbuild/mirrordeb"

# service address
dapp_mirrordeb_traefik_address: "mirror.{{ dapp_common_domain }}"

# Delay between automatic mirror update.
# No auto-update if not defined.
# dapp_mirrordeb_update_delay: 6h

# You can modify the following 'dapp_mirrordeb_directory_*' variables, but if you do,
# you'll have to create the directories yourself; this role won't do it.

# main directory for debmirror destination
dapp_mirrordeb_directory_mirrors: "./mirrors"
# directory for 'extras' packages
dapp_mirrordeb_directory_extras: "./extras"
# directory for key files
dapp_mirrordeb_directory_keys: "./keys"

# mirror settings (remove '--dry-run' option when all is set)
dapp_mirrordeb_mirrors:
  - name: debian
    host: debian.mirror.rafal.ca
    root: /debian
    dist: bookworm,bookworm-updates
    arch: amd64
    section: main,contrib,non-free,non-free-firmware,main/debian-installer
    dest: /var/www/html/mirrors/debian/
    method: rsync
    options: --nosource --i18n --passive --cleanup --verbose --dry-run
  - name: debian-security
    host: debian.mirror.rafal.ca
    root: /debian-security
    dist: bookworm-security
    arch: amd64
    section: main,contrib,non-free,non-free-firmware,main/debian-installer
    dest: /var/www/html/mirrors/debian-security/
    method: rsync
    options: --nosource --i18n --passive --cleanup --verbose --dry-run
  - name: ubuntu
    host: ca.archive.ubuntu.com
    root: /ubuntu
    dist: jammy,jammy-security
    arch: amd64
    section: main,restricted,universe,multiverse
    dest: /var/www/html/mirrors/ubuntu/
    method: rsync
    options: --nosource --i18n --passive --cleanup --verbose --dry-run

# signing keys
dapp_mirrordeb_signing_keys:
  - https://ftp-master.debian.org/keys/archive-key-11.asc
  - https://ftp-master.debian.org/keys/archive-key-11-security.asc
  - https://ftp-master.debian.org/keys/archive-key-12.asc
  - https://ftp-master.debian.org/keys/archive-key-12-security.asc
  - https://ftp-master.debian.org/keys/release-11.asc
  - https://ftp-master.debian.org/keys/release-12.asc
  - https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x630239cc130e1a7fd81a27b140976eaf437d05b5 # Ubuntu Archive Automatic Signing Key
  - https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf6ecb3762474eda9d21b7022871920d1991bc93c # Ubuntu Archive Automatic Signing Key(2018)

# Dockerfile to build the container
dapp_mirrordeb_dockerfile: |
  FROM debian:stable-slim
  RUN DEBIAN_FRONTEND=noninteractive apt-get update && \
    apt-get install -y --no-install-recommends debmirror ed gnupg gpgv curl nginx dpkg-dev && \
    apt-get -y upgrade && \
    apt-get autoremove && \
    rm -rf /var/cache/apt/*
  COPY entrypoint.sh /entrypoint.sh

  # bash file to run dpkg-scanpackages on /var/www/html/extras/
  RUN echo "#!/bin/bash\ncd /var/www/html/extras/ && dpkg-scanpackages -m . > Packages && cat Packages | gzip > Packages.gz" > /run-extras-scanpackages.sh

  # bash file to run debmirror
  RUN echo '#!/bin/bash\n\
  {% for amirror in dapp_mirrordeb_mirrors %}
  echo "debmirror {{ amirror.name }} ..."\n\
  debmirror {{ amirror.options }}\\\n\
    --method={{ amirror.method }} --host={{ amirror.host }} --root={{ amirror.root }}\\\n\
    --dist={{ amirror.dist }} --arch={{ amirror.arch }}\\\n\
    --section={{ amirror.section }} {{ amirror.dest }}\n\
  \n\
  {% endfor %}\n'\
  >> /run-debmirror.sh

  # bash file to download signing keys
  RUN echo '#!/bin/bash\n\
  touch /root/.gnupg/trustedkeys.gpg\n\
  chmod 0600 /root/.gnupg/trustedkeys.gpg\n\
  {% for akey in dapp_mirrordeb_signing_keys %}
  curl --silent "{{ akey }}" | gpg --no-default-keyring --keyring trustedkeys.gpg --import -\n\
  {% endfor %}\n'\
  >> /run-signing-keys.sh

  RUN chmod u+x /entrypoint.sh && \
    chmod u+x /run-extras-scanpackages.sh && \
    chmod u+x /run-debmirror.sh && \
    chmod u+x /run-signing-keys.sh && \
    rm -f /var/www/html/index.nginx-debian.html
  COPY nginx.conf /etc/nginx/sites-enabled/default
  EXPOSE 80
  ENTRYPOINT ["/entrypoint.sh"]

# container entrypoint.sh
dapp_mirrordeb_entrypoint: |
  #!/bin/bash
  {% if dapp_mirrordeb_update_delay is defined %}
  echo "starting nginx"
  nginx
  # Auto update mirror
  while true; do
    /run-signing-keys.sh
    /run-extras-scanpackages.sh
    /run-debmirror.sh
    echo "going to sleep ..."
    sleep {{ dapp_mirrordeb_update_delay }}
  done
  {% else %}
  echo "starting nginx"
  nginx -g 'daemon off;'
  {% endif %}

# nging configuration file
dapp_mirrordeb_nginx_conf: |
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/html;
    index index.html;
    server_name _;
    location / {
      autoindex on;
      try_files $uri $uri/ =404;
    }
    access_log syslog:server=unix:/dev/log;
    error_log syslog:server=unix:/dev/log;
  }
